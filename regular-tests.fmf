summary: Run .NET regular tests
description: |
    Run dotnet-regular-tests and verify tests are passing.

execute:
    how: tmt 
    script: |
      set -euo pipefail

      cat /etc/os-release
      if [[ $dotnet_version == 9.* ]]; then
        dnf install 'dnf-command(copr)' -y
        if grep centos /etc/os-release; then
          dnf copr enable @dotnet-sig/dotnet-preview centos-stream-10-x86_64 -y
        else
          dnf copr enable @dotnet-sig/dotnet-preview -y
        fi
        dnf install -y dotnet-sdk-aot-$dotnet_version
      fi
      if grep fedora /etc/os-release; then
        dnf install -y dotnet-sdk-$dotnet_version
          if [[ ! $dotnet_version == *6* ]]; then
            dnf install -y \
              dotnet-sdk-dbg-$dotnet_version\
              dotnet-runtime-dbg-$dotnet_version \
              aspnetcore-runtime-dbg-$dotnet_version
          fi
      elif grep alpine /etc/os-release; then
        if grep edge /etc/os-release; then
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories
        fi
        apk add dotnet-sdk-$dotnet_version dotnet-doc
        if [[ ! $dotnet_version == *6* ]]; then
          apk add \
            dotnet-sdk-dbg-$dotnet_version \
            dotnet-runtime-$dotnet_version \
            aspnetcore-runtime-dbg-$dotnet_version
        fi
      fi

      if grep fedora /etc/os-release ; then
          dnf install -y python3 wget $(grep '^Dependencies(dnf): ' README.md | cut -d: -f2-) --skip-broken
        elif grep alpine /etc/os-release; then
          apk add python3 wget curl $(grep '^Dependencies(apk): ' README.md | cut -d: -f2-)
        echo -e '[PostgreSQL]\nDescription=PostgreSQL Unicode\nDriver=/usr/lib/psqlodbcw.so\nUsageCount=1' > /etc/odbcinst.ini
      fi

      wget --no-verbose https://github.com/redhat-developer/dotnet-bunny/releases/latest/download/turkey.tar.gz
      tar xf turkey.tar.gz

      ### This is very questionable, but making our CI fail because distro
      ### .NET versions are out of date doesn't sound nice.
      rm -rf release-version-sane

      dotnet turkey/Turkey.dll -v --timeout 600

      find -iname '*log' -exec echo {} \; -exec cat {} \;